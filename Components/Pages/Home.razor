@page "/"
@using BlazorAzureADB2CApp1.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using BlazorAzureADB2CApp1.Components

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject Models.TestContext DbContext
@inject NavigationManager Navigation
@inject ThemeService ThemeService
@inject UserStateService UserStateService


<PageTitle>Home</PageTitle>

<MudStack AlignItems="AlignItems.Center" Spacing="3" Class="pa-3">
    @if (ThemeService.IsDarkMode)
    {
        <MudImage ObjectFit="ObjectFit.Contain" Src="images/hoikun.svg" Alt="hoikun logo" Class="ma-12" />
    }
    else
    {
        <MudImage ObjectFit="ObjectFit.Contain" Src="images/hoikun_light.svg" Alt="hoikun logo" Class="ma-12" />
    }
    <MudText>
        「hoikun」は幼稚園・保育園向けのデータ支援アプリケーションです。
    </MudText>

    @if (string.IsNullOrEmpty(UserStateService.Email))
    {
        <MudAlert Severity="Severity.Warning">
            <MudLink Href="MicrosoftIdentity/Account/SignIn" Target="_blank" Typo="Typo.body2" Color="Color.Primary">
                <b>ログインしてください。</b>
            </MudLink>
        </MudAlert>

    }
    else if (!string.IsNullOrEmpty(UserStateService.Email) && !isRegister)
    {
        <MudAlert Severity="Severity.Warning">
            通園登録がされていません。
            <MudLink Href="/register" Typo="Typo.body2" Color="Color.Primary">
                登録はこちら。
            </MudLink>
        </MudAlert>
    }
    else
    {
        <MudAlert Severity="Severity.Success">
            ログイン済みです！ようこそ、@UserStateService.Username さん！
        </MudAlert>
        <MudStack Spacing="2">
            @foreach (Children child in parent.Children)
            {
                <MudText Typo="Typo.h6">お子様情報 @child.Rank</MudText>
                <MudText Typo="Typo.body2">お名前: @child.Name</MudText>
                <MudText Typo="Typo.body2">園からの連絡：***あいうえおかきくけこ*** 2024/12/12</MudText>
                <MudButton Color="Color.Primary">More Info</MudButton>
            }
        </MudStack>
    }

</MudStack>
@code {
    private bool isRegister = true;
    private int parentId = 1;
    private Parent parent = new();

    private void OnThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        ThemeService.OnThemeChanged += OnThemeChanged;
        if(UserStateService.Email != null)
        {
            parent = await DbContext.Parents.FirstOrDefaultAsync(p => p.EmailAddress == UserStateService.Email) ?? new() ;
            if(parent != null && parent.Children != null)
            {
                parentId = parent.ParentId;
                isRegister = true;
            }
            else
            {
                isRegister = false;
            }
        }

    }
}
