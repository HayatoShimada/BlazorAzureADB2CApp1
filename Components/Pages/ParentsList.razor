@page "/parentslist"

@using Azure.Storage.Sas
@using BlazorAzureADB2CApp1.Models
@using Microsoft.EntityFrameworkCore
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using FluentValidation
@using FluentValidation.Results
@using MudBlazor
@using Azure.Identity
@using Azure.Storage
@using Azure.Storage.Blobs
@using Azure.Storage.Blobs.Models
@using Azure.Storage.Blobs.Specialized

@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject TestContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserStateService UserStateService
@inject IConfiguration Configuration
@inject BlobStorageService BlobService
@inject IDialogService DialogService


<PageTitle>親情報一覧</PageTitle>
<MudSnackbarProvider />
<MudText Typo="Typo.h5" GutterBottom="true">親情報一覧</MudText>


@if (parents == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudTable Items="@parents"
        Hover="true"
        Breakpoint="Breakpoint.Sm"
        Loading="@_loading"
        LoadingProgressColor="Color.Info"
        ReadOnly="@ronly"
        CanCancelEdit="@canCancelEdit"
        ApplyButtonPosition="@applyButtonPosition"
        EditButtonPosition="@editButtonPosition"
        EditTrigger="@editTrigger">

        <HeaderContent>
            <MudTh>ID</MudTh>
            <MudTh>名前</MudTh>
            <MudTh>住所</MudTh>
            <MudTh>電話番号</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate Context="parent">
            <MudTd DataLabel="ParentId">@parent.ParentId</MudTd>
            <MudTd DataLabel="Name">@parent.Name</MudTd>
            <MudTd DataLabel="Address">@parent.CurrentAddress</MudTd>
            <MudTd DataLabel="Phone">@parent.HomePhoneNumber</MudTd>
            <MudTd>
                <MudButton Variant="Variant.Outlined"
                Size="Size.Small"
                OnClick="@(parent.ShowDetail != true ? () => ShowBtnPress(parent) : () => CloseDetail(parent))">
                    @((parent.ShowDetail == true) ? "子供詳細" : "子供詳細")
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                Size="Size.Small"
                OnClick="@(parent.ShowMap != true ? () => RoutePress(parent) : () => CloseDetail(parent) )">
                    @((parent.ShowMap == true) ? "通園経路" : "通園経路")
                </MudButton>

                <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => SendMessageDialog(parent))">送信</MudButton>

            </MudTd>
        </RowTemplate>

        <ChildRowContent Context="parent">
            @if (parent.ShowDetail == true)
            {
                <MudTr >
                    <td colspan="5">
                        <MudTable Items="@parent.Children"
                            Hover="true"
                            Breakpoint="Breakpoint.Sm"
                            Loading="@_loading"
                            LoadingProgressColor="Color.Info"
                            ReadOnly="@ronly"
                            CanCancelEdit="@canCancelEdit"
                            ApplyButtonPosition="@applyButtonPosition"
                            EditButtonPosition="@editButtonPosition"
                            EditTrigger="@editTrigger"
                            Style="filter: brightness(90%)">

                            <HeaderContent>
                                <MudTh>ID</MudTh>
                                <MudTh>名前</MudTh>
                                <MudTh>誕生日</MudTh>
                                <MudTh>アレルギー</MudTh>
                            </HeaderContent>

                            <RowTemplate Context="child">
                                <MudTd DataLabel="ChildrenId">@child.ChildId</MudTd>
                                <MudTd DataLabel="Name">@child.Name</MudTd>
                                <MudTd DataLabel="Birthday">@child.Birthday</MudTd>
                                <MudTd DataLabel="AllergyInfo">@child.AllergyInfo</MudTd>
                            </RowTemplate>

                        </MudTable>
                    </td>
                </MudTr>
            }
            @if (parent.ShowMap == true)
            {
                <MudTr>
                    <td colspan="5">
                        @if (_blobFiles.Any())
                        {
                            @foreach (var file in _blobFiles)
                            {
                                <div class="d-flex justify-center">
                                    <MudImage ObjectFit="ObjectFit.Contain" Src="@file.Url" Width="400" Class="rounded-lg" />
                                </div>

                            }
                        }
                        else if (_isBlobLoading)
                        {
                            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                        }
                        else
                        {
                        }
                    </td>
                </MudTr>
            }
        </ChildRowContent>
    </MudTable>
}


@code {
    private List<Parent>? parents;

    private bool _loading = false;
    private bool ronly = false;
    private bool canCancelEdit = true;

    private TableApplyButtonPosition applyButtonPosition = TableApplyButtonPosition.End;
    private TableEditButtonPosition editButtonPosition = TableEditButtonPosition.End;
    private TableEditTrigger editTrigger = TableEditTrigger.RowClick;


    protected override async Task OnInitializedAsync()
    {
        // 親リストを子リストを含めて取得
        parents = null;

        try
        {
            parents = await DbContext.Parents
            .Include(p => p.Children) // 子リストを同時にロード
            .ToListAsync();
        }
        catch(Exception ex)
        {
            Snackbar.Add($"データの読み込み中にエラーが発生しました: {ex.Message}", MudBlazor.Severity.Error);
        }


    }

    private void ShowBtnPress(Parent parent)
    {
        if (parents != null)
        {
            parents.ForEach(item => item.ShowMap = false);
            parents.ForEach(item => item.ShowDetail = false);
            parent.ShowDetail = !parent.ShowDetail;
            StateHasChanged();
        }

    }

    private async void RoutePress(Parent parent)
    {
        if (parents != null)
        {
            parents.ForEach(item => item.ShowMap = false);
            parents.ForEach(item => item.ShowDetail = false);
            parent.ShowMap = !parent.ShowMap;
            await LoadFiles(parent);
            StateHasChanged();
        }
    }

    private void CloseDetail(Parent parent)
    {
        parent.ShowDetail = false;
        parent.ShowMap = false;

    }

    private void LineMessage(Children child)
    {
        // Line 送信処理
        Snackbar.Add("Line 送信処理", MudBlazor.Severity.Info);
    }


    // アップロードファイルの表示ロジック
    private List<BlobFileInfo> _blobFiles = new();
    private bool _isBlobLoading = false;

    private async Task LoadFiles(Parent parent)
    {
        _isBlobLoading = true;
        _blobFiles = await BlobService.LoadFilesAsync(parent.ParentId);
        _isBlobLoading = false;

    }

    // メッセージ送信用
    string _returnValue = String.Empty;
    private readonly DialogOptions _maxWidth = new() { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseOnEscapeKey = true };

    private async void SendMessageDialog(Parent parent)
    {
        var options = _maxWidth;
        var dialogReference = await DialogService.ShowAsync<SendDialog>("メッセージ送信", options);
        StateHasChanged();


        var dialogResult = await dialogReference.Result;
        if (dialogResult.Canceled)
        {
            StateHasChanged();
        }
        else
        {
            _returnValue = $"Dialog returned '{dialogResult.Data}'";
            StateHasChanged();
        }
    }


}
